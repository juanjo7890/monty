#include "monty.h"

int main(int argc, char *argv[])
{
  char buffer[1024];
  FILE *monty_file;
  int line = 0;
  stack_ss *stack;
  instruction_t instruct[] = {{"push", NULL}, {"pall", NULL}};

  if (argc != 2)
    {
      printf("USAGE: monty file\n");
      exit(EXIT_ERROR);
    }
  if ((monty_file = fopen(argv[1], "r")) == NULL)
    {
      printf("ERROR: Can't open file %s\n", argv[1]);
      exit(EXIT_FAILIURE);
    }
  /* Indicate the end of the file give 0 if didn't find the end of the file */
  while (!feof(monty_file))
    {
      /* the 1024 is the number the file is goint to read */
      if (fgets(buffer, 1024, monty_file) != NULL)
	excute(&stack, line, buffer, instruct);
    }
  fclose(monty_file);
  return(0);
}

int excute(stack_ss **st, unsigned int line, char *command,
	   instruction_t instruct[])
{
  char *word;
  int i;
  int num = 0;

  word = strtok(command, " ");
  for (i = 0; instruct[i].opcode != NULL; i++)
    {
      if (strcmp(instruct[i].opcode, word) == 0)
	{
	  instruct[i].f(st, line);
	  if (strcmp(instruct[i].opcode, "push"))
	    {
	      number = strtok(NULL, command);
	      num = atoi(word);
	      if (num != 0)
		(*st)->n = num;
	    }
	  return (1);
	}
    }
  printf("L%u: Unknown instruction %s\n", line, word);
  return (0);
}
